<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">

<dom-module id="d2l-image">
	<template>
		<style>
			:host {
				display: block;
			}

			img {
				width:100%;
				height: 100%;
			}
		</style>

		<iron-ajax id="imageRequest" url="[[imageUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onImageResponse" handle-as="arraybuffer" verbose="true"></iron-ajax>

		<img id="image" alt="{{alternateText}}"/>
	</template>
	<script>
	'use strict';

	Polymer({
		is: 'd2l-image',
		properties: {
			alternateText: String,
			imageUrl: {
				type: String,
				value: null
			},
			token: String,
			_headers: String
		},
		observers: [
			'_onImageUrlChange( imageUrl, token )'
		],
		behaviors: [
			window.D2L.Hypermedia.OrganizationHMBehavior,
			window.D2L.Hypermedia.HMConstantsBehavior
		],
		_onImageUrlChange: function() {
			if (this.token) {
				this._headers = {
					Authorization: 'Bearer ' + this.token
				};
				this.$.imageRequest.generateRequest();
			}
		},

		_onImageResponse: function(response) {
			if (response.detail.status === 200) {
				var data = new Uint8Array(response.detail.response);
				var rawData = String.fromCharCode.apply(null, data);
				var base64 = window.btoa(rawData);
				var dataUrl = 'data:image/png;base64,' + base64;
				this.$.image.src = dataUrl;
			} else {
				this.fire('d2l-image-failed-to-load', response);
			}
		}
	});
	</script>
</dom-module>
